<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E.BANK | ورود</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "6235857d-565c-4223-bffa-af420f2cd45b" });
      });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background: #fdfdfd;
            background-image: radial-gradient(#e2e8f0 0.8px, transparent 0.8px);
            background-size: 25px 25px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid #f1f5f9;
            box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.05);
        }
        input { text-align: right !important; direction: rtl !important; }
        .ltr-input { direction: ltr !important; text-align: right !important; }
        .btn-premium { background: #0f172a; transition: all 0.3s ease; }
        .btn-premium:active { transform: scale(0.96); background: #000; }
        @keyframes float { 0% { transform: translateY(0px) rotate(3deg); } 50% { transform: translateY(-5px) rotate(-3deg); } 100% { transform: translateY(0px) rotate(3deg); } }
        .logo-animate { animation: float 4s ease-in-out infinite; }
        #splash-screen { transition: opacity 0.7s ease; z-index: 2000; }
        body.loading { overflow: hidden; height: 100vh; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="loading p-4">

    <!-- ۱. Splash Screen (لوگوی شروع) -->
    <div id="splash-screen" class="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-20 h-20 bg-gradient-to-tr from-emerald-500 to-emerald-400 rounded-2xl flex items-center justify-center shadow-[0_0_40px_rgba(16,185,129,0.3)] animate-pulse">
                <i class="fas fa-university text-white text-3xl"></i>
            </div>
            <div class="absolute -inset-4 bg-emerald-500/10 blur-3xl rounded-full"></div>
        </div>
        <div class="mt-6 text-center">
            <h1 class="text-2xl font-black text-white tracking-[0.2em] ml-2">E<span class="text-emerald-500">.</span>BANK</h1>
        </div>
    </div>

    <!-- ۲. کارت لاگین اصلی (گوشه‌ها اصلاح شد) -->
    <div class="login-card w-full max-w-sm p-8 rounded-[2.5rem]">
        
        <!-- بخش لوگوی سبز رنگ که درخواست دادی -->
        <div class="text-center mb-6">
            <div class="logo-animate w-14 h-14 bg-emerald-500 rounded-2xl shadow-xl shadow-emerald-100 flex items-center justify-center text-white mx-auto mb-3">
                <i class="fas fa-wallet text-2xl"></i>
            </div>
            <h2 class="text-2xl font-[900] text-slate-900 tracking-tighter leading-none">E<span class="text-emerald-500">.</span>BANK</h2>
            <p class="text-[7px] text-slate-400 font-bold uppercase mt-1.5 tracking-[0.3em]">Secure Access Portal</p>
        </div>

        <div class="space-y-3.5">
            <div class="relative">
                <label class="text-[8px] text-slate-400 font-black mr-4 mb-0.5 block uppercase">Pool ID</label>
                <input type="text" id="login-pool-code" placeholder="کد اختصاصی بانک" 
                    class="ltr-input w-full p-3.5 pr-10 bg-slate-50 border border-transparent rounded-2xl text-sm font-black outline-none focus:bg-white focus:border-emerald-500 placeholder:text-slate-300 uppercase">
                <i class="fas fa-key absolute right-4 top-8 text-slate-300 text-xs"></i>
            </div>

            <div class="relative">
                <label class="text-[8px] text-slate-400 font-black mr-4 mb-0.5 block uppercase">Mobile Number</label>
                <input type="tel" id="login-mobile" placeholder="شماره موبایل" 
                    class="ltr-input w-full p-3.5 pr-10 bg-slate-50 border border-transparent rounded-2xl text-sm font-black outline-none focus:bg-white focus:border-emerald-500 placeholder:text-slate-300">
                <i class="fas fa-phone-alt absolute right-4 top-8 text-slate-300 text-xs"></i>
            </div>

            <div class="relative">
                <label class="text-[8px] text-slate-400 font-black mr-4 mb-0.5 block uppercase">Security Pin</label>
                <input type="password" id="login-password" placeholder="رمز عبور" 
                    class="w-full p-3.5 pr-10 bg-slate-50 border border-transparent rounded-2xl text-sm font-black outline-none focus:bg-white focus:border-emerald-500 placeholder:text-slate-300">
                <i class="fas fa-lock absolute right-4 top-8 text-slate-300 text-xs"></i>
            </div>
            
            <button onclick="handleLogin()" id="login-btn" 
                class="btn-premium w-full text-white py-4 rounded-2xl font-black text-xs shadow-xl flex items-center justify-center gap-2 mt-2">
                <span>تایید هویت و ورود</span>
            </button>

            <div class="flex flex-col gap-2 pt-4 text-center">
                <button onclick="alert('با مدیر تماس بگیرید')" class="text-[8px] font-bold text-slate-400">فراموشی رمز عبور</button>
                <div class="h-px bg-slate-100 w-1/3 mx-auto my-0.5"></div>
                <button onclick="location.href='create_pool.html'" class="text-[10px] font-black text-emerald-600 flex items-center justify-center gap-1">
                    تأسیس بانک جدید <i class="fas fa-plus-circle text-[9px]"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ۳. امضای هنری (مکان اصلاح شد) -->
    <div class="mt-8 text-center">
        <p class="text-[7px] font-black text-slate-300 uppercase tracking-[0.4em] opacity-80">
            Designed & Developed by <span class="text-emerald-500">EDDIE</span>
        </p>
    </div>

    <script>
        const SUPABASE_URL = 'https://kqnsbnpznkwkwukzokik.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ZqXeccdaSzZUivCwU38WcQ_m05uT4y6';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.style.opacity = '0';
                    setTimeout(() => { splash.remove(); document.body.classList.remove('loading'); }, 700);
                }
            }, 2500);
            const lastPool = localStorage.getItem('saved_pool_code');
            if (lastPool) document.getElementById('login-pool-code').value = lastPool;
        });

        async function handleLogin() {
            const poolCode = document.getElementById('login-pool-code').value.trim().toUpperCase();
            const mobile = document.getElementById('login-mobile').value.trim();
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            if (!poolCode || !mobile || !password) return alert("فیلدها را پر کنید");
            btn.innerText = "تایید اعتبار..."; btn.disabled = true;
            
            try {
                const { data: pool } = await supabaseClient.from('pools').select('id').eq('pool_code', poolCode).maybeSingle();
                if (!pool) { btn.disabled = false; btn.innerText = "تایید هویت و ورود"; return alert("❌ کد بانک غلط است"); }
                
                const { data: user } = await supabaseClient.from('members').select('*').eq('pool_id', pool.id).eq('mobile', mobile).eq('password', password).maybeSingle();
                if (!user) { btn.disabled = false; btn.innerText = "تایید هویت و ورود"; return alert("❌ مشخصات اشتباه است"); }
                
                localStorage.clear(); sessionStorage.clear();
                sessionStorage.setItem('user_id', user.id);
                sessionStorage.setItem('pool_id', user.pool_id);
                sessionStorage.setItem('user_name', user.full_name);
                sessionStorage.setItem('is_admin', String(user.is_admin));
                localStorage.setItem('saved_pool_code', poolCode);
                localStorage.setItem('is_super_admin', (user.is_super_admin === true || mobile === '09120612550') ? 'true' : 'false');
                
                window.location.replace(user.is_admin ? 'admin.html' : 'member.html');
            } catch (e) { alert("خطا: " + e.message); btn.disabled = false; }
        }
    </script>
</body>
</html>
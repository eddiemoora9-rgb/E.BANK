<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ورود به سیستم | پلتفرم بانکی دوستانه</title>
    
    <!-- ۱. بارگذاری کتابخانه دیتابیس -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ۲. بارگذاری Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ۳. بارگذاری آیکون‌ها -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background: #fdfdfd;
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 20px 20px; /* بک‌گراند نقطه‌ای بسیار ملایم */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #f1f5f9;
        }

        /* استایل اختصاصی برای راست‌چین کردن تمام اینپوت‌ها */
        input {
            text-align: right !important;
            direction: rtl !important;
        }

        /* برای شماره موبایل که عدد انگلیسی بماند اما سمت راست باشد */
        input[type="tel"], input[type="text"].pool-code {
            direction: ltr !important;
            text-align: right !important;
        }

        .btn-tap { transition: all 0.2s ease; }
        .btn-tap:active { transform: scale(0.96); }

        .input-group:focus-within i { color: #10b981; }
        .input-group:focus-within input { background: white; border: 1px solid #10b981; }
    </style>

</head>

<body class="p-6">
    
   

    <div class="login-card w-full max-w-sm p-10 rounded-[3.5rem] shadow-2xl shadow-slate-200/60">
        <!-- لوگو و تیتر -->
        <div class="text-center mb-10">
            <div class="w-16 h-16 bg-emerald-500 rounded-3xl shadow-xl shadow-emerald-100 flex items-center justify-center text-white mx-auto mb-6 transform rotate-3">
                <i class="fas fa-wallet text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight">ورود به صندوق</h2>
            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">Digital Banking Portal</p>
        </div>

        <div class="space-y-5">
            <!-- کادر کد صندوق -->
            <div class="relative input-group">
                <input type="text" id="login-pool-code" placeholder="کد صندوق" 
                    class="pool-code w-full p-4 pr-12 bg-slate-50 border border-transparent rounded-[1.8rem] text-sm font-black outline-none transition-all placeholder:text-slate-300 uppercase">
                <i class="fas fa-key absolute right-5 top-5 text-slate-300 transition-colors"></i>
            </div>

            <!-- کادر شماره موبایل -->
            <div class="relative input-group">
                <input type="tel" id="login-mobile" placeholder="شماره موبایل" 
                    class="w-full p-4 pr-12 bg-slate-50 border border-transparent rounded-[1.8rem] text-sm font-black outline-none transition-all placeholder:text-slate-300">
                <i class="fas fa-phone-alt absolute right-5 top-5 text-slate-300 transition-colors"></i>
            </div>

            <!-- کادر رمز عبور -->
            <div class="relative input-group">
                <input type="password" id="login-password" placeholder="رمز عبور" 
                    class="w-full p-4 pr-12 bg-slate-50 border border-transparent rounded-[1.8rem] text-sm font-black outline-none transition-all placeholder:text-slate-300">
                <i class="fas fa-lock absolute right-5 top-5 text-slate-300 transition-colors"></i>
            </div>
            
            <!-- دکمه ورود -->
            <button onclick="handleLogin()" id="login-btn" 
                class="btn-tap w-full bg-slate-900 text-white py-4 rounded-[1.8rem] font-black text-sm shadow-xl mt-4 flex items-center justify-center gap-2">
                <span>ورود به پنل کاربری</span>
                <i class="fas fa-chevron-left text-[10px] opacity-40"></i>
            </button>

            <!-- فراموشی رمز -->
            <div class="text-center">
                <button onclick="alert('لطفا با مدیر صندوق تماس بگیرید')" class="text-[10px] font-bold text-slate-400 hover:text-emerald-500 transition-colors">رمز عبور را فراموش کرده‌اید؟</button>
            </div>
        </div>
        
        <!-- امضای اختصاصی ادیسون -->
<div class="mt-10 text-center">
    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] opacity-70">
        Designed & Developed by <span class="text-emerald-600">EDDIE</span>
    </p>
</div>
        
        
    </div>

    <script>
        // تنظیمات دیتابیس
        const SUPABASE_URL = 'https://kqnsbnpznkwkwukzokik.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ZqXeccdaSzZUivCwU38WcQ_m05uT4y6';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function handleLogin() {
            const poolCode = document.getElementById('login-pool-code').value.trim().toUpperCase();
            const mobile = document.getElementById('login-mobile').value.trim();
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            if (!poolCode || !mobile || !password) {
                alert("لطفاً تمام فیلدها را پر کنید ❌");
                return;
            }
            
            btn.innerText = "در حال بررسی...";
            btn.disabled = true;
            
            try {
                // ۱. پیدا کردن صندوق
                const { data: pool, error: pErr } = await supabaseClient
                    .from('pools')
                    .select('id')
                    .eq('pool_code', poolCode)
                    .maybeSingle();
                
                if (pErr) throw pErr;
                if (!pool) {
                    btn.disabled = false;
                    btn.innerText = "ورود";
                    return alert("❌ کد صندوق یافت نشد!");
                }
                
                // ۲. پیدا کردن عضو در آن صندوق
                const { data: user, error: uErr } = await supabaseClient
                    .from('members')
                    .select('*')
                    .eq('pool_id', pool.id)
                    .eq('mobile', mobile)
                    .eq('password', password)
                    .maybeSingle();
                
                if (uErr) throw uErr;
                
                if (!user) {
                    btn.disabled = false;
                    btn.innerText = "ورود";
                    return alert("❌ شماره موبایل یا رمز عبور اشتباه است!");
                }
                
                // ۳. پاکسازی و ذخیره اطلاعات جدید
                localStorage.clear();
                localStorage.setItem('user_id', user.id);
                localStorage.setItem('pool_id', user.pool_id);
                localStorage.setItem('user_name', user.full_name);
                localStorage.setItem('is_admin', String(user.is_admin));
                
                // تنظیم وضعیت سوپر ادمین
                const isSuper = (user.is_super_admin === true || mobile === '09120612550') ? 'true' : 'false';
                localStorage.setItem('is_super_admin', isSuper);
                
                // ۴. هدایت به صفحه مربوطه
                if (user.is_admin === true) {
                    window.location.replace('admin.html');
                } else {
                    window.location.replace('index.html');
                }
                
            } catch (e) {
                alert("خطا در برقراری ارتباط: " + e.message);
                btn.disabled = false;
                btn.innerText = "تلاش مجدد";
            }
        }
    </script>
</body>
</html>